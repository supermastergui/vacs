import Button from "./ui/Button.tsx";
import "../styles/call-list.css";
import {CallListItem, useCallListStore} from "../stores/call-list-store.ts";
import {clsx} from "clsx";
import {startCall, useCallStore} from "../stores/call-store.ts";
import {useState} from "preact/hooks";
import List from "./ui/List.tsx";
import {useSignalingStore} from "../stores/signaling-store.ts";

function CallList() {
    const calls = useCallListStore(state => state.callList);
    const {clearCallList} = useCallListStore(state => state.actions);
    const callDisplay = useCallStore(state => state.callDisplay);
    const [selectedCall, setSelectedCall] = useState<number>(0);

    const connected = useSignalingStore(state => state.connectionState === "connected");

    function callRow(index: number, isSelected: boolean, onClick: () => void) {
        return <CallRow call={calls[index]} isSelected={isSelected} onClick={onClick}/>;
    }

    return (
        <div className="w-[37.5rem] h-full flex flex-col gap-3 p-3">
            <List
                className="w-full"
                itemsCount={calls.length}
                selectedItem={selectedCall}
                setSelectedItem={setSelectedCall}
                defaultRows={11}
                row={callRow}
                header={[{title: "Name", className: "col-span-2"}, {title: "Number"}]}
                columnWidths={["minmax(3.5rem,auto)", "1fr", "1fr"]}
                enableKeyboardNavigation={true}
            />
            <div className="w-full shrink-0 flex flex-row justify-between pr-16 [&_button]:h-15 [&_button]:rounded">
                <Button color="gray" onClick={clearCallList}>
                    <p>Delete<br/>List</p>
                </Button>
                <Button color="gray" className="w-56 text-xl"
                        disabled={!connected || calls[selectedCall]?.number === undefined}
                        onClick={async () => {
                            const peerId: string | undefined = calls[selectedCall]?.number;
                            if (peerId === undefined || callDisplay !== undefined) return;
                            await startCall(peerId);
                        }}
                >
                    Call
                </Button>
            </div>
        </div>
    );
}

type CallRowProps = {
    call: CallListItem | undefined;
    isSelected: boolean;
    onClick: () => void;
};

function CallRow(props: CallRowProps) {
    const color = props.isSelected ? "bg-blue-700 text-white" : "bg-yellow-50";

    return (
        <>
            <div
                className={clsx("p-0.5 text-center flex flex-col justify-between leading-4", color)}
                onClick={props.onClick}
            >
                <p>{props.call?.type ?? ""}</p>
                <p className="tracking-wider font-semibold">{props.call?.time ?? ""}</p>
            </div>
            <div
                className={clsx("px-0.5 flex items-center font-semibold", color)}
                onClick={props.onClick}
            >
                {props.call?.name ?? ""}
            </div>
            <div
                className={clsx("px-0.5 flex items-center font-semibold", color)}
                onClick={props.onClick}
            >
                {props.call?.number ?? ""}
            </div>
        </>
    );
}

export default CallList;