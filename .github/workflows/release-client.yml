name: Release â€¢ vacs-client

on:
  push:
    tags:
      - 'vacs-client-v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (1.2.3, v1.2.3, or vacs-client-v1.2.3)'
        required: true
        type: string
      ref:
        description: 'Git ref to build (branch/tag/SHA). Empty = default branch tip.'
        required: false
        default: ''
        type: string

jobs:
  prep:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.vars.outputs.version }}
      tag: ${{ steps.vars.outputs.tag }}
      draft: ${{ steps.vars.outputs.draft }}
      prerelease: ${{ steps.vars.outputs.prerelease }}
      release_name: ${{ steps.vars.outputs.release_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Resolve version & tag
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            RAW="${{ inputs.version }}"
          else
            RAW="${GITHUB_REF_NAME}"  # e.g. vacs-client-v1.2.3
          fi

          # Extract X.Y.Z from: 1.2.3 | v1.2.3 | vacs-client-v1.2.3 | 1.2.3-rc.1
          if [[ "$RAW" =~ ([0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9.-]+)?) ]]; then
            VER="${BASH_REMATCH[1]}"
          else
            echo "Could not parse semver from: $RAW" >&2
            exit 1
          fi

          TAG="vacs-client-v${VER}"
          REL_NAME="vacs-client: v${VER}"

          # Draft release when manual; published on tag-push
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            DRAFT=true
          else
            DRAFT=false
          fi

          # Mark prerelease if version contains a prerelease part (e.g., -rc.1)
          if [[ "$VER" =~ -[A-Za-z0-9] ]]; then
            PRERELEASE=true
          else
            PRERELEASE=false
          fi

          echo "version=$VER"       >> "$GITHUB_OUTPUT"
          echo "tag=$TAG"           >> "$GITHUB_OUTPUT"
          echo "draft=$DRAFT"       >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "release_name=$REL_NAME" >> "$GITHUB_OUTPUT"

  build:
    needs: prep
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'ubuntu-22.04'
            arch: 'x86_64'
            target: ''
          - platform: 'windows-latest'
            arch: 'x86_64'
            target: ''
          - platform: 'macos-latest'
            arch: 'aarch64'
            target: 'aarch64-apple-darwin' # for Arm based macs (M1 and above).
          - platform: 'macos-latest'
            arch: 'x86_64'
            target: 'x86_64-apple-darwin' # for Intel based macs.

    runs-on: ${{ matrix.platform }}
    permissions:
      contents: read
      attestations: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref }}

      - name: Prepare additional version information for manual release
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          # create/update a lightweight tag locally so vergen sees it
          git tag -f "${{ needs.prep.outputs.tag }}" HEAD
          git describe --tags --always
          # override version info built into client
          echo "VACS_VERSION_OVERRIDE=${{ needs.prep.outputs.version }}" >> "$GITHUB_ENV"
          # build tauri user config with version info
          echo "EXTRA_TAURI_ARGS=--config '{\"version\":\"${{ needs.prep.outputs.version }}\"}'" >> "$GITHUB_ENV"

      - name: Install build dependencies (Linux)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev \
            libssl-dev libasound2-dev libgtk-3-dev libopus-dev \
            cmake patchelf

      - name: Install build dependencies (macOS, aarch64)
        if: matrix.platform == 'macos-latest' && matrix.arch == 'aarch64'
        run: |
          brew update
          brew install opus

      - name: Install build dependencies (macOS, x86_64)
        if: matrix.platform == 'macos-latest' && matrix.arch == 'x86_64'
        run: |
          if [ ! -f /usr/local/bin/brew ]; then
            arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          fi
          
          arch -x86_64 /usr/local/bin/brew update
          arch -x86_64 /usr/local/bin/brew install opus
          
          echo "PKG_CONFIG_PATH=/usr/local/opt/opus/lib/pkgconfig" >> $GITHUB_ENV
          echo "PKG_CONFIG_ALLOW_CROSS=1" >> $GITHUB_ENV

      - name: Setup Node (LTS)
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: |
            vacs-client/package-lock.json
            vacs-client/frontend/package-lock.json

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install frontend dependencies
        working-directory: vacs-client
        run: npm ci

      - name: Build
        uses: tauri-apps/tauri-action@v0
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_SIGNING_RPM_KEY: ${{ secrets.TAURI_SIGNING_RPM_KEY }}
          TAURI_SIGNING_RPM_KEY_PASSPHRASE: ${{ secrets.TAURI_SIGNING_RPM_KEY_PASSPHRASE }}
        with:
          projectPath: vacs-client
          appVersion: ${{ needs.prep.outputs.version }}
          args: ${{ matrix.target && format('--target {0}', matrix.target) }} ${{ env.EXTRA_TAURI_ARGS }}
          includeUpdaterJson: false

      - name: Rename macOS bundles to include version & architecture
        if: matrix.platform == 'macos-latest'
        shell: bash
        run: |
          if [[ "${{ matrix.target }}" == "" ]]; then
            BUNDLE_DIR="target/release/bundle"
          else
            BUNDLE_DIR="target/${{ matrix.target }}/release/bundle"
          fi
          
          if [[ -f "$BUNDLE_DIR/macos/vacs.app.tar.gz" ]]; then
            mv "$BUNDLE_DIR/macos/vacs.app.tar.gz" "$BUNDLE_DIR/macos/vacs_${{ needs.prep.outputs.version }}_${{ matrix.arch }}.app.tar.gz"
          fi
          if [[ -f "$BUNDLE_DIR/macos/vacs.app.tar.gz.sig" ]]; then
            mv "$BUNDLE_DIR/macos/vacs.app.tar.gz.sig" "$BUNDLE_DIR/macos/vacs_${{ needs.prep.outputs.version }}_${{ matrix.arch }}.app.tar.gz.sig"
          fi

      - name: Upload bundles as artifact
        uses: actions/upload-artifact@v5
        with:
          name: bundles-${{ matrix.platform }}-${{ matrix.arch }}
          if-no-files-found: error
          retention-days: 30
          path: |
            target/**/release/bundle/**/*.msi
            target/**/release/bundle/**/*.msi.sig
            target/**/release/bundle/**/*.exe
            target/**/release/bundle/**/*.exe.sig
            target/**/release/bundle/**/*.deb
            target/**/release/bundle/**/*.deb.sig
            target/**/release/bundle/**/*.rpm
            target/**/release/bundle/**/*.rpm.sig
            target/**/release/bundle/**/*.AppImage
            target/**/release/bundle/**/*.AppImage.sig
            target/**/release/bundle/macos/vacs_*_*.app.tar.gz
            target/**/release/bundle/macos/vacs_*_*.app.tar.gz.sig
            target/**/release/bundle/dmg/*.dmg
            target/**/release/bundle/dmg/*.dmg.sig

      - name: Attest build provenance
        if: ${{ !github.event.repository.private || github.event.repository.owner.type == 'Organization' }}
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: |
            target/**/release/bundle/**/*.msi
            target/**/release/bundle/**/*.msi.sig
            target/**/release/bundle/**/*.exe
            target/**/release/bundle/**/*.exe.sig
            target/**/release/bundle/**/*.deb
            target/**/release/bundle/**/*.deb.sig
            target/**/release/bundle/**/*.rpm
            target/**/release/bundle/**/*.rpm.sig
            target/**/release/bundle/**/*.AppImage
            target/**/release/bundle/**/*.AppImage.sig
            target/**/release/bundle/macos/vacs_*_*.app.tar.gz
            target/**/release/bundle/macos/vacs_*_*.app.tar.gz.sig
            target/**/release/bundle/dmg/*.dmg
            target/**/release/bundle/dmg/*.dmg.sig

  release:
    needs: [prep, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Download bundles from artifacts
        uses: actions/download-artifact@v6
        with:
          path: dist
          pattern: bundles-*
          merge-multiple: true

      - name: Generate checksums
        working-directory: dist
        run: |
          out="SHA256SUMS-${{ needs.prep.outputs.version }}.txt"
          : > "$out"
          while IFS= read -r -d '' f; do
            sum=$(shasum -a 256 "$f" | cut -d' ' -f1)
            echo "$sum  $(basename "$f")" >> "$out"
          done < <(find . -type f \
            ! -name 'SHA256SUMS*' \
            ! -name '*.app' \
            -print0 | sort -z)

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums using Cosign with GitHub OIDC Token
        working-directory: dist
        run: |
          cosign sign-blob --yes \
            --output-signature "SHA256SUMS-${{ needs.prep.outputs.version }}.txt.sig" \
            --output-certificate "SHA256SUMS-${{ needs.prep.outputs.version }}.txt.pem" \
            "SHA256SUMS-${{ needs.prep.outputs.version }}.txt"

      - name: Create/update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prep.outputs.tag }}
          name: ${{ needs.prep.outputs.release_name }}
          draft: ${{ needs.prep.outputs.draft }}
          prerelease: ${{ needs.prep.outputs.prerelease }}
          make_latest: ${{ needs.prep.outputs.draft == 'false' && needs.prep.outputs.prerelease == 'false' }}
          files: |
            dist/**
