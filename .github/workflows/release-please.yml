name: Release Please

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Target branch to prepare releases from (leave empty for default behavior).'
        required: false
        default: ''
        type: string

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.release.outputs.prs }}

    steps:
      - uses: googleapis/release-please-action@v4.4.0
        id: release
        with:
          target-branch: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref != '' && github.event.inputs.ref || github.ref_name }}
          token: ${{ secrets.RELEASE_PLEASE_PAT }}

  update-lockfiles:
    needs: release-please
    if: ${{ needs.release-please.outputs.prs }}
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.release-please.outputs.prs) }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.pr.headBranchName }}
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PLEASE_PAT }}

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Update cargo workspace lockfile
        run: cargo update -w

      - name: Setup Node (LTS)
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: |
            vacs-client/package-lock.json
            vacs-client/frontend/package-lock.json

      - name: Update npm workspace lockfile
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        working-directory: vacs-client
        run: npm install --package-lock-only

      - name: Commit updated lockfiles
        run: |
          if [ -n "$(git status --porcelain -- Cargo.lock vacs-client/package-lock.json)" ]; then
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add Cargo.lock vacs-client/package-lock.json 2>/dev/null || true
            git commit -m "chore(lockfile): refresh cargo & npm lockfiles after version bumps"
            git push
          else
            echo "No lockfile changes detected."
          fi