name: Release Please

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Target branch to prepare releases from (leave empty for default behavior).'
        required: false
        default: ''
        type: string

permissions: {}

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.release.outputs.prs }}

    steps:
      - name: Generate GitHub token
        uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-pull-requests: write
          permission-contents: write
      - uses: googleapis/release-please-action@v4.4.0
        id: release
        with:
          target-branch: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref != '' && github.event.inputs.ref || github.ref_name }}
          token: ${{ steps.generate-token.outputs.token }}

  update-lockfiles:
    needs: release-please
    if: ${{ needs.release-please.outputs.prs }}
    strategy:
      fail-fast: false
      matrix:
        pr: ${{ fromJson(needs.release-please.outputs.prs) }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub token
        uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-contents: write
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ matrix.pr.headBranchName }}
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }}

      - name: Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: 'ubuntu-22.04-x86_64'

      - name: Update cargo workspace lockfile
        run: cargo update -w

      - name: Setup Node (LTS)
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        uses: actions/setup-node@v6
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: |
            vacs-client/package-lock.json
            vacs-client/frontend/package-lock.json

      - name: Update npm workspace lockfile
        if: contains(join(matrix.pr.files, ','), 'vacs-client')
        working-directory: vacs-client
        run: npm install --package-lock-only

      - name: Commit updated lockfiles
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ steps.generate-token.outputs.token }}
          commit-message: 'chore(lockfile): refresh cargo & npm lockfiles after version bumps'
          sign-commits: 'true'
          add-paths: |
            Cargo.lock
            vacs-client/package-lock.json